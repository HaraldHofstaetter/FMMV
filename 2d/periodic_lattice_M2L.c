#include "_fmmv.h"

#include<assert.h>


static _FLOAT_ MM_ws1[] = {
/* 3rd col = (k-1)! times 2nd col */
/*  2 ... pi */
/*  4   1.512120021538975382e-01 */9.0727201292338533e-01, 
/*  8   5.7730353651894942e-03 */  2.9096098240555051e+01,
/* 12   1.3490128279703747e-03 */  5.3848275251527855e+04,
/* 16   7.0033025024855870e-05 */  9.1580391738506585e+07,
/* 20   3.0031762895595772e-06 */  3.6532168128889832e+11,
/* 24   2.4280383862810116e-07 */  6.2769689004791980e+15,
/* 28   1.6099409965709789e-08 */  1.7530437334537811e+20,
/* 32   8.9758066666893292e-10 */  7.3806610011280911e+24,
/* 36   5.7045151271059143e-11 */  5.8945598884873475e+29,
#if (FMM_PRECISION==1)
/* 40   3.7180310586178652e-12 */  7.5839959107916908e+34,
/* 44   2.2744025145537520e-13 */  1.3740862622876387e+40,
/* 48   1.4081285775545639e-14 */  3.6417477719167167e+45,
/* 52   8.9097416933543892e-16 */  1.3820067427508469e+51,
/* 56   5.5655838097435276e-17 */  7.0662896947093931e+56,
/* 60   3.4617327481687554e-18 */  4.8008389308778426e+62,
/* 64   2.1678173400149608e-19 */  4.2979326845915960e+68,
/* 68   1.3566184768600142e-20 */  4.9477382943225763e+74,
/* 72   8.4682093760432183e-22 */  7.2020307578343728e+80,
/* 76   5.2922456038352380e-23 */  1.3129606639403664e+87,
/* 80   3.3094447765677763e-24 */  2.9606895722943688e+93,
/* 84   2.0680633809167306e-25 */  8.1595936403085017e+99,
/* 88   1.2923290806020023e-26 */ 2.7239160515469741e+106,
/* 92   8.0780717135949184e-28 */ 1.0921565297476019e+113,
/* 96   5.0489043219484384e-29 */ 5.2155073034904547e+119,
/*100   3.1553782794313410e-30 */ 2.9447951311335096e+126
#endif
};

static _FLOAT_ MM_ws2[] = {
/*  2 ... pi */
/*  4   5.3312002153897545e-02 */  3.1987201292338530e-01,
/*  8  -3.5567134810483232e-05 */ -1.7925835944483548e-01,
/* 12   2.5868130328747481e-06 */  1.0325729847065475e+02,
/* 16   1.1745380535431164e-07 */  1.5359133068589450e+05,
/* 20   1.9807197779991556e-09 */  2.4094485627646670e+08,
/* 24   1.5254606058133557e-11 */  3.9436233115996490e+11,
/* 28   1.0027630627155722e-13 */  1.0918956079611536e+15,
/* 32   1.6557958174877590e-15 */  1.3615341851464477e+19,
/* 36   3.1035634312085642e-17 */  3.2069580157743182e+23,
/* 40   4.0533487149144646e-19 */  8.2679729120798432e+27,
#if (FMM_PRECISION==1)
/* 44   4.0478244358837427e-21 */  2.4455037812826909e+32,
/* 48   4.2408786363526600e-23 */  1.0967897797889876e+37,
/* 52   5.7748975093954052e-25 */  8.9575518251358087e+41,
/* 56   8.1821341636463104e-27 */  1.0388367563540098e+47,
/* 60   1.0154142083731510e-28 */  1.4082080903279152e+52,
/* 64   1.1512803731728846e-30 */  2.2825380412144879e+57,
/* 68   1.3586799485185518e-32 */  4.9552567104738990e+62,
/* 72   1.7446847514384246e-34 */  1.4838170248992228e+68,
/* 76   2.2542444079505327e-36 */  5.5925866940145402e+73,
/* 80   2.7718912726941077e-38 */  2.4797844172249298e+79,
/* 84   3.3155547336020616e-40 */  1.3081600674347720e+85,
/* 88   4.0447366495910263e-42 */  8.5253231931986415e+90,
/* 92   5.0728561126963387e-44 */  6.8585092140581707e+96,
/* 96   6.3557643931528538e-46 */  6.5654909457584713e+102,
/*100   7.8193356370113001e-48 */  7.2974900228822645e+108
#endif
};


void periodic_lattice_M2L(FmmvHandle *FMMV, _FLOAT_ *M, _FLOAT_ *L)
{
	_FLOAT_ *MM;
        _FLOAT_ INV_F[FMM_P_MAX+2]; /* 1/factorials */
        int pM = FMMV->pM;
        int pL = FMMV->pL;
        int p = (pM>pL?pM:pL);
        int m,k, kk;
        _FLOAT_ h, l_re, l_im;
        _FLOAT_ PI = 3.14159265358979323846;

        INV_F[0] = 1.0;
        for (m=1;m<=p;m++) {
            INV_F[m] = m*INV_F[m-1];
            INV_F[m-1] = 1.0/INV_F[m-1];
        }
        INV_F[p] = 1.0/INV_F[p];


	switch (FMMV->ws) {
	case 1:
		MM = MM_ws1;
		break;
	case 2:	
	        assert(0);
		MM = MM_ws2;
		break;
	}	

        for (m=0;m<=pL;m++) {
        //for (m=1;m<=pL;m++) {
            l_re = 0.0;
            l_im = 0.0;
            kk = m/4;
            for (k=4-m%4; k<=pM; k+=4) {
                 //printf("%3i %3i %3i %3i\n", m,k,m+k, kk);
                 h = MM[kk]*INV_F[k-1]*INV_F[m];
                 l_re += h*M[2*k  ];
                 l_im += h*M[2*k+1];
                 kk++;
            }
            if (m%2) {
               L[2*m  ] = -l_re;
               L[2*m+1] = -l_im;
            }
            else {
               L[2*m  ] = l_re;
               L[2*m+1] = l_im;
            } 
        }
        L[2*0  ] += PI*M[2*2  ];
        L[2*0+1] += PI*M[2*2+1]; 
        L[2*1  ] -= PI*M[2*1  ];
        L[2*1+1] -= PI*M[2*1+1];
}

